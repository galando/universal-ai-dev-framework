---
description: PIV API design rules for controllers and routes
globs: ["*Controller*", "*Router*", "*Route*", "routes/*", "controllers/*", "*Handler*"]
alwaysApply: false
---

# API Design Rules

## üõë When Creating API Endpoints

**Follow this workflow for EVERY endpoint:**

1. **Write the API test FIRST** (TDD applies to APIs too)
2. **Define the request/response contract** before implementing
3. **Implement ONE endpoint** ‚Üí test ‚Üí confirm ‚Üí then next
4. **NEVER** create multiple endpoints in one go

---

## RESTful Principles

### URL Design
- ‚úÖ **Nouns over verbs**: `/users` not `/getUsers`
- ‚úÖ **Plural nouns**: `/users` not `/user`
- ‚úÖ **Resource hierarchy**: `/users/{id}/posts`
- ‚ùå **Never nest more than 3 levels**: `/users/{id}/posts/{id}/comments/{id}` is too deep

### HTTP Verbs
| Verb | Purpose | Idempotent |
|------|---------|------------|
| GET | Read resource | Yes |
| POST | Create resource | No |
| PUT | Update entire resource | Yes |
| PATCH | Partial update | Yes |
| DELETE | Remove resource | Yes |

---

## Response Format

### Success Response
```json
{
  "data": { ... },
  "meta": { "page": 1, "total": 100 }
}
```

### Error Response
```json
{
  "error": "ErrorCode",
  "message": "Human-readable description",
  "details": { ... }
}
```

### HTTP Status Codes
| Code | Use Case |
|------|----------|
| 200 | Success (GET, PUT, PATCH, DELETE) |
| 201 | Created (POST) |
| 204 | No Content (DELETE) |
| 400 | Bad Request (validation failed) |
| 401 | Unauthorized (not logged in) |
| 403 | Forbidden (logged in, no permission) |
| 404 | Not Found |
| 409 | Conflict (duplicate resource) |
| 500 | Server Error |

---

## üö® FORBIDDEN Patterns

### ‚ùå Don't Do This
```javascript
// Verbs in URL
GET /getUsers
POST /createUser

// Singular nouns
GET /user/123

// Inconsistent responses
{ "user": {...} }      // sometimes
{ "data": {...} }      // sometimes
{ "result": {...} }    // sometimes
```

### ‚úÖ Do This Instead
```javascript
// Nouns with HTTP verbs
GET /users
POST /users

// Plural nouns
GET /users/123

// Consistent responses
{ "data": {...}, "meta": {...} }  // always
```

---

## Best Practices

### Input Validation
- **ALWAYS** validate request body, params, query
- **RETURN** 400 with specific error messages
- **NEVER** trust client-side validation only

### API Versioning
- Use `/v1/`, `/v2/` prefix for breaking changes
- Maintain backward compatibility when possible
- Document deprecation timeline

### Rate Limiting
- **IMPLEMENT** rate limits on all public endpoints
- **USE** standard headers: `X-RateLimit-Limit`, `X-RateLimit-Remaining`

---

<!-- PIV Spec-Kit v2.1.0 -->
