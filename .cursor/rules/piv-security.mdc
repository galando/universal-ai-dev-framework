---
description: PIV security rules for authentication and security code
globs: ["*Auth*", "*Security*", "*Password*", "*Token*", "*Credential*", "*Session*"]
alwaysApply: false
---

# Security Rules

## üõë When Implementing Security Features

**Follow this workflow:**

1. **Write security test FIRST** (test for vulnerabilities, not just happy path)
2. **Implement ONE security feature** ‚Üí test ‚Üí verify ‚Üí then next
3. **ALWAYS** ask: "Should I add rate limiting/logging here?"
4. **NEVER** skip security for "internal only" or "MVP"

---

## Golden Rule

**NEVER trust user input.**

Validate EVERYTHING from untrusted sources:
- Form submissions
- API requests (even from authenticated users)
- File uploads
- URL parameters
- Webhooks (third-party APIs too)

---

## Input Validation

### Validation Checklist
- ‚úÖ **Structure**: Is the data shape correct?
- ‚úÖ **Type**: String, number, boolean as expected?
- ‚úÖ **Format**: Email, URL, UUID valid?
- ‚úÖ **Length**: Within min/max bounds?
- ‚úÖ **Range**: Within acceptable values?
- ‚úÖ **Sanitize**: Remove dangerous characters

### SQL Injection Prevention
```javascript
// ‚ùå VULNERABLE - Never concatenate
const query = `SELECT * FROM users WHERE id = '${userId}'`;

// ‚úÖ SECURE - Parameterized query
const query = 'SELECT * FROM users WHERE id = $1';
await db.query(query, [userId]);
```

### XSS Prevention
```javascript
// ‚ùå VULNERABLE
div.innerHTML = userInput;

// ‚úÖ SECURE
div.textContent = userInput;
// or use framework auto-escaping (React, Vue)
```

---

## Authentication & Passwords

### Password Storage
```javascript
// ‚ùå FORBIDDEN - Never use these for passwords
MD5, SHA1, SHA256, SHA512

// ‚úÖ REQUIRED - Use password hashing functions
bcrypt, argon2, scrypt
```

### Example (bcrypt)
```javascript
import bcrypt from 'bcrypt';

// Hash with cost factor 10+
const hash = await bcrypt.hash(password, 10);

// Compare
const match = await bcrypt.compare(password, hash);
```

### JWT Tokens
- **Secret**: Minimum 256 bits (32+ characters)
- **Expiration**: 1 hour or less for access tokens
- **Refresh tokens**: Store securely, rotate frequently
- **Algorithm**: Use RS256 (asymmetric) for production

```javascript
// ‚ùå Too short
const secret = "mysecret";

// ‚úÖ Proper length
const secret = crypto.randomBytes(32).toString('hex');
```

---

## üö® FORBIDDEN Patterns

### ‚ùå Never Do This
```javascript
// Plain text passwords
users.insert({ password: "password123" })

// Weak hashing
const hash = md5(password);

// Hardcoded secrets
const apiKey = "sk_live_1234567890";

// SQL concatenation
const query = `SELECT * FROM users WHERE id = ${req.params.id}`;

// Unescaped output
res.send(`<div>${userInput}</div>`);
```

### ‚úÖ Always Do This Instead
```javascript
// Hash passwords
const hash = await bcrypt.hash(password, 10);

// Environment variables
const apiKey = process.env.API_KEY;

// Parameterized queries
const query = 'SELECT * FROM users WHERE id = $1';

// Escaped/templated output
res.send(`<div>${escape(userInput)}</div>`);
```

---

## Rate Limiting

**IMPLEMENT on ALL authentication endpoints:**
- POST `/auth/login` - 5 requests per 15 minutes per IP
- POST `/auth/register` - 3 requests per hour per IP
- POST `/auth/forgot-password` - 3 requests per hour per email

**USE standard headers:**
```
X-RateLimit-Limit: 5
X-RateLimit-Remaining: 3
X-RateLimit-Reset: 1640000000
```

---

## Data Protection

### Secrets Management
- ‚úÖ Use `.env` files (add to `.gitignore`)
- ‚úÖ Use secret managers in production (Vault, AWS Secrets Manager)
- ‚ùå Never commit secrets to git
- ‚ùå Never hardcode credentials

### Sensitive Data
- ‚úÖ Encrypt at rest (PII, passwords, tokens)
- ‚úÖ Use TLS in production (HTTPS only)
- ‚úÖ Hash passwords before storage
- ‚ùå Never log sensitive data

---

## Common Vulnerabilities (OWASP Top 10)

| Vulnerability | Prevention |
|---------------|------------|
| Injection | Parameterized queries, input validation |
| Broken Auth | Strong passwords, MFA, rate limiting |
| XSS | Output escaping, CSP headers |
| Broken Access Control | Check permissions on EVERY request |
| Security Misconfiguration | Default deny, disable debug in prod |
| Sensitive Data Exposure | Encrypt at rest, TLS in transit |
| XSS | Output escaping, Content-Security-Policy |
| Insecure Deserialization | Validate input, use safe formats |
| Using Components with Known Vulnerabilities | `npm audit`, Dependabot |
| Insufficient Logging & Monitoring | Log auth attempts, errors, rate limits |

---

<!-- PIV Spec-Kit v2.1.0 -->
